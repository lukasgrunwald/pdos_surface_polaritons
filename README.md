This code is adapted from an original implementation at
